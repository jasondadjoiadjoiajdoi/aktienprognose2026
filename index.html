<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KI Aktien Analyse 2026</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{background:#0f1115;color:#e7fdf9;font-family:system-ui;margin:0;padding:12px}
h1{text-align:center;font-size:1.4rem;margin:6px 0}
small{text-align:center;display:block;color:#9cc}
select,button{width:100%;padding:14px;margin-top:10px;font-size:1rem;border-radius:12px;border:1px solid #00ccaa;background:#141822;color:#e7fdf9}
button:disabled{opacity:.6}
.status{text-align:center;margin-top:8px;font-weight:bold}
.hint{text-align:center;font-size:.85rem;color:#9cc}
.progress{height:7px;background:#1e2433;border-radius:4px;overflow:hidden;margin-top:6px}
.progress div{height:100%;width:0%;background:#00ccaa;transition:.3s}
.box{background:#141822;border:1px solid #00ccaa;border-radius:12px;padding:10px;margin-top:10px}
canvas{margin-top:12px;background:#111;border-radius:12px}
</style>
</head>

<body>

<h1>KI Aktien Analyse 2026</h1>
<small>Client-only ‚Ä¢ Key-frei ‚Ä¢ GitHub Pages tauglich</small>

<select id="stock"></select>
<button id="analyzeBtn">üîç Analyse starten</button>

<div class="status" id="marketStatus">Marktstatus‚Ä¶</div>
<div class="hint" id="countdown"></div>
<div class="status" id="status">Bereit</div>

<div class="progress"><div id="bar"></div></div>

<canvas id="chart" height="260"></canvas>

<div class="box">
  <b>Analyse-Hinweis</b>
  <div id="info">‚Äì</div>
</div>

<script>
/* ================= AKTIEN ================= */
const STOCKS=[
 ["AAPL","Apple"],["MSFT","Microsoft"],["NVDA","NVIDIA"],
 ["TSLA","Tesla"],["AMZN","Amazon"],["GOOGL","Alphabet"],
 ["META","Meta"],["SAP","SAP"],["ASML","ASML"],
 ["NESN","Nestl√©"],["ROG","Roche"],["ABB","ABB"],
 ["JPM","JPMorgan"],["V","Visa"],["MA","Mastercard"],
 ["KO","Coca-Cola"],["AMD","AMD"],["INTC","Intel"]
];

const stockSel=document.getElementById("stock");
STOCKS.forEach(s=>{
  const o=document.createElement("option");
  o.value=s[0]; o.textContent=s[0]+" ‚Äì "+s[1];
  stockSel.appendChild(o);
});

/* ================= MARKT ================= */
function getMarket(sym){
  return ["SAP","ASML","NESN","ROG","ABB"].includes(sym)?"EU":"US";
}
function marketTimes(){
  const m=getMarket(stockSel.value);
  const n=new Date(),d=n.getDay();
  const h=n.getHours()+n.getMinutes()/60;
  if(d===0||d===6) return {open:false,next:"Montag",market:m};
  if(m==="EU"){
    if(h>=9&&h<17.5) return {open:true,closeIn:17.5-h,market:m};
    if(h<9) return {open:false,openIn:9-h,market:m};
    return {open:false,next:"Morgen 09:00",market:m};
  }
  if(h>=15.5&&h<22) return {open:true,closeIn:22-h,market:m};
  if(h<15.5) return {open:false,openIn:15.5-h,market:m};
  return {open:false,next:"Morgen 15:30",market:m};
}
function updateMarket(){
  const m=marketTimes();
  marketStatus.textContent=m.open?"üü¢ B√∂rse offen":"üî¥ B√∂rse geschlossen";
  countdown.textContent=m.open
    ?`Schlie√üt in ${Math.round(m.closeIn*60)} Min`
    :m.openIn?`√ñffnet in ${Math.round(m.openIn*60)} Min`
    :`N√§chste √ñffnung: ${m.next}`;
}
setInterval(updateMarket,30000);
updateMarket();

/* ================= CHART ================= */
let chart;
function drawChart(prices){
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"line",
    data:{labels:prices.map((_,i)=>i),datasets:[{data:prices,borderColor:"#00ccaa",tension:.3}]},
    options:{plugins:{legend:{display:false}},responsive:true}
  });
}

/* ================= COMMON ================= */
const bar=document.getElementById("bar");
const status=document.getElementById("status");
const info=document.getElementById("info");
const btn=document.getElementById("analyzeBtn");
function progress(p){bar.style.width=p+"%";}
</script>
<script>
/* ================= SYMBOL FIX ================= */
function normalizeSymbol(s){
  const map={"SAP":"SAP","ASML":"ASML","NESN":"NESN","ROG":"ROG","ABB":"ABB"};
  return map[s]||s;
}

/* ================= CACHE + COOLDOWN ================= */
const CACHE_MINUTES = 30;
function getCacheKey(sym){ return "sp_cache_"+sym; }

function loadFromCache(sym){
  const raw = localStorage.getItem(getCacheKey(sym));
  if(!raw) return null;
  try{
    const c = JSON.parse(raw);
    if(Date.now() - c.time < CACHE_MINUTES*60000) return c.data;
  }catch{}
  return null;
}
function saveToCache(sym,data){
  localStorage.setItem(getCacheKey(sym),JSON.stringify({time:Date.now(),data}));
}

/* ================= LIVE DATEN ================= */
async function loadMarketData(){
  const sym = normalizeSymbol(stockSel.value);

  const cached = loadFromCache(sym);
  if(cached) return cached;

  try{
    const r = await fetch(`https://stockprices.dev/api/stocks/${sym}`);
    const d = await r.json();

    if(!d || !d.Price) throw "NO_DATA";

    const prices = [d.Price]; // nur der aktuelle Preis, Chart zeigt Linie

    saveToCache(sym,prices);
    return prices;
  }catch{
    const cachedData = loadFromCache(sym);
    if(cachedData) return cachedData;
    return {__error:"FETCH_FAILED"};
  }
}

/* ================= KI ================= */
let KI_AKTIV = true;
const kiBtn = document.createElement("button");
kiBtn.textContent = "üß† KI: EIN";
kiBtn.style.width="100%";
kiBtn.style.marginTop="8px";
document.body.insertBefore(kiBtn,document.getElementById("marketStatus"));

kiBtn.addEventListener("click",()=>{
  KI_AKTIV = !KI_AKTIV;
  kiBtn.textContent = KI_AKTIV ? "üß† KI: EIN" : "üß† KI: AUS";
});

function runKI(prices){
  const n = prices.length-1;
  let score = 0, reasons=[];
  if(prices[n]>Math.min(...prices.slice(0,Math.max(n-5,0)))){score+=3; reasons.push("‚Ä¢ Aufw√§rtstrend");}
  if(prices[n]>Math.min(...prices.slice(0,Math.max(n-12,0)))){score+=2; reasons.push("‚Ä¢ Mittelfristig positiv");}
  if(prices[n]>prices[n-1]||prices.length===1){score+=2; reasons.push("‚Ä¢ Momentum positiv");}
  const vol = prices.length>1?Math.abs(prices[n]-prices[Math.max(n-4,0)])/prices[n]:0;
  if(vol<0.03){score+=2; reasons.push("‚Ä¢ Ruhige Phase");}else{score-=1; reasons.push("‚Ä¢ Volatil");}

  let signal="HALTEN";
  if(score>=8) signal="KAUFEN";
  if(score<=3) signal="VERKAUFEN";

  return {
    signal,
    timing: score>=8?"üü¢ Guter Einstieg":score>=5?"üü° Beobachten":"üî¥ Schwach",
    stability: Math.min(95,45+score*6),
    invalid: (prices[n]*0.965).toFixed(2),
    reasons
  };
}

/* ================= ANALYSE START ================= */
btn.addEventListener("click",async()=>{
  btn.disabled=true;
  status.textContent="Analyse l√§uft‚Ä¶";
  progress(20);

  const data = await loadMarketData();

  if(data.__error){
    info.textContent = data.__error==="FETCH_FAILED"?"‚ö†Ô∏è Netzwerk/Server nicht erreichbar":"‚ö†Ô∏è Fehler";
    status.textContent="‚ö†Ô∏è Analyse nicht m√∂glich";
    btn.disabled=false;
    progress(0);
    return;
  }

  drawChart(data);
  progress(60);

  const result = KI_AKTIV ? runKI(data) : {
    signal:"HALTEN", timing:"Neutral", stability:50, invalid:"‚Äì", reasons:["‚Ä¢ KI AUS"]
  };

  info.innerHTML=`
    <b>Signal:</b> ${result.signal}<br>
    <b>Timing:</b> ${result.timing}<br>
    <b>Stabilit√§t:</b> ${result.stability}%<br>
    <b>Kipppunkt:</b> ${result.invalid}<br><br>
    ${result.reasons.join("<br>")}
  `;

  progress(100);
  status.textContent="‚úÖ Analyse abgeschlossen";
  btn.disabled=false;
});
</script>
</body>
</html>
